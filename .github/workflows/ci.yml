name: CI

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  rust-checks:
    name: Rust Lint & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: rustfmt, clippy
          override: true

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check Rust formatting
        run: cargo fmt --all -- --check

      - name: Clippy lint
        run: cargo clippy --all-targets -- -D warnings

      - name: Cargo tests
        run: cargo test --no-fail-fast

  anchor-build:
    name: Anchor Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Solana CLI
        uses: jito-foundation/solana-programs-action@v1
        with:
          solana-version: "1.18"
          anchor-version: "0.32.1"

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache Anchor build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/
            .anchor/
          key: ${{ runner.os }}-anchor-${{ hashFiles('**/Cargo.lock', '**/Anchor.toml', 'programs/**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-anchor-

      - name: Build Anchor program
        run: anchor build
        env:
          ANCHOR_PROVIDER_URL: http://127.0.0.1:8899

      - name: Verify IDL generation
        run: |
          anchor idl build || echo "IDL build requires deployed program (expected in CI)"

  typescript-checks:
    name: TypeScript Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules/
            app/node_modules/
            scripts/node_modules/
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install root npm dependencies
        run: npm ci

      - name: Install app dependencies
        run: npm ci
        working-directory: app

      - name: Install scripts dependencies
        run: npm ci
        working-directory: scripts

      - name: Typecheck scripts
        run: npm run typecheck --prefix scripts

      - name: App ESLint
        run: npm run lint --prefix app

      - name: App typecheck
        run: npm run typecheck --prefix app

      - name: Prettier check
        run: npm run format:check

  frontend-build:
    name: Next.js Build
    runs-on: ubuntu-latest
    needs: typescript-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules/
            app/node_modules/
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install root npm dependencies
        run: npm ci

      - name: Install app dependencies
        run: npm ci
        working-directory: app

      - name: Build Next.js app
        run: npm run build
        working-directory: app
        env:
          # Use dummy values for build - actual values needed at runtime
          NEXT_PUBLIC_RPC_URL: http://127.0.0.1:8899
          NEXT_PUBLIC_NETWORK: localnet

  # Integration tests require a running validator - skip in CI for now
  # Uncomment when validator service is available or tests are refactored
  # anchor-test:
  #   name: Anchor Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: [rust-checks, anchor-build]
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Setup Rust toolchain
  #       uses: actions-rs/toolchain@v1
  #       with:
  #         toolchain: stable
  #         profile: minimal
  #     - name: Install Solana CLI
  #       uses: jito-foundation/solana-programs-action@v1
  #       with:
  #         solana-version: "1.18"
  #         anchor-version: "0.32.1"
  #     - name: Start validator
  #       run: |
  #         solana-test-validator --reset &
  #         sleep 10
  #     - name: Run Anchor tests
  #       run: anchor test

  # E2E tests require frontend dev server - skip until tests are implemented
  # See vision.md: "E2E testing: Structure ready, full tests pending"
  # e2e-tests:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   needs: [frontend-build]
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 20
  #     - name: Install dependencies
  #       run: npm ci
  #     - name: Install Playwright browsers
  #       run: npx playwright install --with-deps
  #     - name: Run E2E tests
  #       run: npm run test:e2e

